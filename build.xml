<project name="TableauDataExtractPlugin" default="dist" basedir=".">
    <description>
        Build the Tableau Data Extract plugin for Pentaho Data Integration.
    </description>
  <!-- set global properties for this build -->
  <property file="build.properties" />
  <property file="build.number" />
  <property name="version" value="1.0.3"/>

  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build}"/>
  </target>

  <!-- software revision number -->

  <target name="increment_the_build_number" depends="init">
	<propertyfile file="build.number"
				  comment="Build Number for ANT. Edit not!">
	<entry key="buildnumber" type="int" 
		 operation="+" 
		 default="1" />
	</propertyfile>
  </target>

  <target name="buildinfo" depends="increment_the_build_number">
    <tstamp>
        <format property="builtat" pattern="MM/dd/yyyy hh:mm aa" timezone="America/New_York"/>
    </tstamp>        
    
    <exec executable="whoami" outputproperty="whoami"/>

    <propertyfile file="${build}/buildinfo.properties"
        comment="This file is automatically generated - DO NOT EDIT">        
        <entry key="buildtime" value="${builtat}"/>
        <entry key="build" value="${buildnumber}"/>
        <entry key="builder" value="${whoami}"/>
        <entry key="version" value="${version}"/>
    </propertyfile>
  </target>
  
  <target name="compile" depends="buildinfo"
        description="compile the source " >
	
    <!-- Compile the java code from ${src} into ${build} -->
    <javac debug="on" debuglevel="lines" includeantruntime="false" target="1.6" source="1.6" srcdir="${src}" destdir="${build}">
		<classpath>
			<fileset dir="${tdeclasspath}/" >
				<include name="dataextract.jar"/>
				<include name="jna.jar"/>
			</fileset>
			<fileset dir="${pentahoclasspath}/" >
				<include name="**/*.jar"/>
				<exclude name="dataextract.jar"/>
				<exclude name="jna.jar"/>
			</fileset>
			<fileset dir="${pentahoswtclasspath}/" >
				<include name="**/*.jar"/>
			</fileset> 
		</classpath>
	</javac>
	<copy todir="${build}">
          <fileset dir="${src}" includes="**/*.png **/*.xml **/*.xul **/*txt **/*properties"/>
    </copy>
  </target>
  
  <target name="dist" depends="compile"
        description="generate the distribution" >
    <!-- Put everything in ${build} into the MyProject-${DSTAMP}.jar file -->
	<mkdir dir="${dist}"/>
	<mkdir dir="${dist}/TDEOutputPlugin"/>
    <jar jarfile="${dist}/TDEOutputPlugin/TDEOutputPlugin.jar" basedir="${build}"/>
	<copy file="plugin.xml" todir="${dist}/TDEOutputPlugin"/>
	<copy file="tde.png" todir="${dist}/TDEOutputPlugin"/>
	<copy file="${tdeclasspath}/dataextract.jar" todir="${dist}/TDEOutputPlugin"/>
	<copy file="${tdeclasspath}/jna.jar" todir="${dist}/TDEOutputPlugin"/>
	<copy file="LICENSE" todir="${dist}/TDEOutputPlugin"/>
	<copy file="README.md" todir="${dist}/TDEOutputPlugin"/>
	<echoxml file="${dist}/TDEOutputPlugin/version.xml">
		<version branch="${branch}" buildId="${buildnumber}">${version}</version>
	</echoxml>
  </target>

  <target name="clean"
        description="clean up" >
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>
</project>